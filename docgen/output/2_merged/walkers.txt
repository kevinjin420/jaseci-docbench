# Walkers

# Walkers

A `walker` is a mobile computational agent that traverses the graph of nodes and edges to process data. Walkers encapsulate object interactions and specify how computation moves through the graph. They are a core archetype in Jac, alongside nodes and edges.

Walkers navigate through the graph structure and execute logic at each visited node or edge. They can be spawned at a `root` node and move using `visit` operations.

## Walker Definition

Walkers are defined using the `walker` keyword. They can have `has` properties and `can` abilities.

```jac
walker Greeter {
    has greeting_count: int = 0;

    can start with `root entry {
        print("Starting journey!");
        visit [-->];
    }

    # ability greet will only execute when Greeter enters a Person type node
    can greet with Person entry {
        print(f"Hello, {here.name}!");
        self.greeting_count += 1;

        # specify how this walker can traverse the graph
        # in this case, visit all outgoing edges from the current node
        visit [-->];
    }
}
```

## Walker Abilities

Walkers contain automatic methods called abilities that trigger on events. Abilities follow the `can <name> with <type> <operation>` syntax.

-   `start`: An ability that runs when the walker spawns at a `root` node.
-   `entry`: An ability that runs when the walker enters a node of a specified type.

```jac
walker Visitor {
    has name: str;

    # runs when walker spawns at root
    can start with `root entry {
        print(f"Starting!");
        visit [-->]; # [-->] corresponds to outgoing connections
        # visit [<--]; incoming connections
        # visit [<-->]; all connections
    }
}
```

## Walker Traversal

Walkers traverse the graph using the `visit` keyword.
-   `visit [-->]`: Moves to adjacent nodes via outgoing connections.
-   `visit [<--]`: Moves to adjacent nodes via incoming connections.
-   `visit [<-->]`: Moves to adjacent nodes via all connections.

A walker stops its traversal using `disengage`.

## Spawning Walkers

Walkers are launched by `spawn`ing them at a node, typically the `root`.

```jac
walker create_post {
    has content: str, author: str;

    can func_name with `root entry {
        new_post = Post(content=self.content, author=self.author);
        here ++> new_post;
        report {"id": new_post.id, "status": "posted"};
    }
}
```

## Python Interoperability (Library Mode)

In Library Mode, Jac walkers can be defined as Python classes inheriting from `jaclang.lib.Walker`.

```python
from jaclang.lib import Walker

class FriendFinder(Walker):
    started: bool = False
```

## Jac Lens Walkers

For Jac Cloud versions prior to 0.2.5, specific walkers are required for Jac Lens functionality. These walkers provide capabilities for retrieving node information, updating node properties, and navigating the graph.

To integrate, create a file named `jaclens.jac` and include it in your main application file.

```jac
walker get_attached_nodes {
    has node_id: str = "";
    can get_attach_nodes with `root entry {
        if(self.node_id == "") {
            report jid(here);
        } else {
            selected_node = &self.node_id;
            attached_nodes = [selected_node-->];
            report attached_nodes;
        }
    }
}

walker update_node_data {
    has node_id: str = "";
    has node_data: dict = {};
    can update_node_data with `root entry {
        selected_node = &self.node_id;
        selected_node.__dict__.update(self.node_data);
        report selected_node;
    }
}
```

**Integration Steps:**
1.  Create `jaclens.jac` in your project.
2.  Copy the walker code above into the file.
3.  Include in your main file: `include jaclens;`

# Walkers

Walkers are special objects that can move through a graph, carrying state and executing abilities when they encounter different types of nodes and edges. This model of "mobile computation" allows code to be sent to data.

## Walker Declaration

A walker is defined with the `walker` archetype. Like an `obj`, it can have `has` attributes to store data and `def` methods for internal logic.

```jac
walker MessageDelivery {
    has message: str;
    has delivery_count: int = 0;
    has visited_locations: list[str] = [];

    # Regular methods work like normal
    def get_status() -> str {
        return f"Delivered {self.delivery_count} messages to {len(self.visited_locations)} locations";
    }
}
```

## Walker Abilities

Walkers execute `can` abilities when they encounter specific node or edge types, or when entering/exiting any node.

-   **`with <NodeType> entry`**: Triggered when the walker enters a node of `<NodeType>`.
-   **`with <NodeType> exit`**: Triggered when the walker exits a node of `<NodeType>`.
-   **`with <EdgeType> entry`**: Triggered when the walker traverses an edge of `<EdgeType>`.
-   **`with entry`**: Triggered when the walker enters *any* node.
-   **`with exit`**: Triggered when the walker exits *any* node.

Inside an ability, `here` refers to the current node or edge the walker is interacting with.

```jac
walker MessageDelivery {
    has message: str;
    has delivery_count: int = 0;
    has visited_locations: list[str] = [];

    # Entry ability - triggered when entering any Student
    can deliver_to_student with Student entry {
        print(f"Delivering message to student {here.name}");
        here.messages.append(self.message);
        self.delivery_count += 1;
        self.visited_locations.append(here.name);
    }

    # Entry ability - triggered when entering any Teacher
    can deliver_to_teacher with Teacher entry {
        print(f"Delivering message to teacher {here.name} ({here.subject})");
        print(f"  {here.name} says: 'Message received!'");
        self.delivery_count += 1;
        self.visited_locations.append(here.name);
    }

    # Exit ability - triggered when leaving any node
    can log_visit with entry {
        node_type = type(here).__name__;
        print(f"  Visited {node_type}");
    }
}
```

## Walker Movement

Walkers move through graphs using `spawn` (to start) and `visit` (to continue to connected nodes).

### `spawn`

To activate a walker, it must be `spawn`ed on a node.

```jac
with entry {
    # Create nodes
    alice = root ++> Student(name="Alice");
    bob = root ++> Student(name="Bob");

    # Create walker instance
    messenger = MessageDelivery(message="School assembly at 2 PM");

    # Spawn walker on Alice - this activates it
    alice[0] spawn messenger;
}
```

### `visit`

The `visit` statement directs the walker to move to connected nodes. It can specify edge patterns.

```jac
walker ClassroomMessenger {
    has announcement: str;
    has rooms_visited: set[str] = {};
    has people_reached: int = 0;

    can deliver_student with Student entry {
        print(f" Student {here.name}: {self.announcement}");
        self.people_reached += 1;

        # Continue to connected nodes via any outgoing edge
        visit [-->];
    }

    can deliver_teacher with Teacher entry {
        print(f" Teacher {here.name}: {self.announcement}");
        self.people_reached += 1;

        # Continue to connected nodes via any outgoing edge
        visit [-->];
    }
}
```

### `disengage`

The `disengage` statement stops the walker's traversal.

```jac
walker AttendanceChecker {
    has present_students: list[str] = [];
    has absent_students: list[str] = [];
    has max_checks: int = 5;
    has checks_done: int = 0;

    can check_attendance with Student entry {
        self.checks_done += 1;

        import random;
        is_present = random.choice([True, False]);

        if is_present {
            print(f"{here.name} is present");
            self.present_students.append(here.name);
        } else {
            print(f"{here.name} is absent");
            self.absent_students.append(here.name);
        }

        if self.checks_done >= self.max_checks {
            print(f"Reached maximum checks ({self.max_checks})");
            self.report_final();
            disengage;  # Stop the walker
        }

        connections = [-->];
        if not connections {
            print("No more students to check");
            self.report_final();
            disengage;
        }

        visit [-->];
    }

    def report_final() -> None {
        print(f" Attendance Report:");
        print(f"   Present: {self.present_students}");
        print(f"   Absent: {self.absent_students}");
        print(f"   Total checked: {self.checks_done}");
    }
}
```

## Key Concepts

-   **Mobile Computation**: Walkers bring processing directly to data locations.
-   **State Management**: Walkers carry their own state (attributes) as they traverse.
-   **Traversal Control**: `spawn`, `visit`, and `disengage` provide fine-grained control over movement patterns.
-   **Focused Abilities**: Each ability should have a single, clear purpose.
-   **Descriptive Naming**: Use clear names for walkers and abilities.
-   **Reporting Results**: Use exit abilities or internal methods to summarize walker activities.

## Walkers as API Endpoints

Walkers can be automatically exposed as RESTful API endpoints. When deployed, each walker becomes an API endpoint, typically at `/walker/<walker_name>`.

### API Endpoint Configuration (`__specs__`)

The `__specs__` object within a walker allows for configuration of its API behavior.

```jac
walker my_walker {
    obj __specs__ {
        static has auth: bool = False;
        static has methods: list = ["get"]; # Default is POST
    }
    // ...
}
```

-   `auth: bool`: If `True`, the endpoint requires authentication.
-   `methods: list`: Specifies the HTTP methods allowed for this endpoint. Defaults to `["post"]`.

### Request and Response Mapping

-   **Request Body to Walker Attributes**: JSON request bodies are automatically mapped to walker attributes.
    ```jac
    walker create_note {
        has title: str;
        has content: str;
        has author: str;
        has priority: int = 1;
        has tags: list[str] = [];
        // ...
    }
    ```
    A JSON request like `{"title": "My Note", "content": "...", "author": "John Doe"}` would populate the `title`, `content`, and `author` attributes of the `create_note` walker.
-   **Parameter Validation**: Jac automatically validates request parameters based on the walker's attribute types. Additional business logic validation can be performed within the walker.
    ```jac
    walker create_note {
        has title: str;
        has content: str;
        has author: str;
        has priority: int = 1;
        has tags: list[str] = [];

        obj __specs__ {
            static has auth: bool = False;
        }

        can validate_and_create with `root entry {
            # Jac automatically validates types before this runs

            # Additional business logic validation
            if len(self.title) < 3 {
                report {"error": "Title must be at least 3 characters"};
                return;
            }

            if self.priority < 1 or self.priority > 5 {
                report {"error": "Priority must be between 1 and 5"};
                return;
            }

            // ... create note
        }
    }
    ```
-   **Response Formatting**: The `report` statement within a walker's `can` block determines the JSON response returned by the API endpoint.
    ```jac
    walker create_note {
        // ...
        can add_note with `root entry {
            // ...
            report {"message": "Note created", "id": new_note.id};
        }
    }
    ```

### CRUD Operations with Walkers

Walkers naturally map to RESTful CRUD (Create, Read, Update, Delete) operations.

#### Create (POST)

```jac
walker create_note {
    has title: str;
    has content: str;
    has author: str;
    has priority: int = 1;

    can add_note with `root entry {
        new_note = Note(
            title=self.title, content=self.content,
            author=self.author, priority=self.priority,
            id="note_" + str(uuid4())
        );
        here ++> new_note;
        report {"message": "Note created", "id": new_note.id};
    }
}
```

#### Read (GET)

```jac
walker list_notes {
    obj __specs__ {
        static has auth: bool = False;
        static has methods: list = ["get"];
    }
    can get_all_notes with `root entry {
        all_notes = [-->(`?Note)];
        report {
            "notes": [
                {
                    "id": n.id,
                    "title": n.title,
                    "author": n.author,
                    "priority": n.priority
                }
                for n in all_notes
            ],
            "total": len(all_notes)
        };
    }
}

walker get_note {
    obj __specs__ {
        static has auth: bool = False;
        static has methods: list = ["get"];
    }
    has note_id: str;

    can fetch_note with `root entry {
        target_note = [-->(`?Note)](?id == self.note_id);

        if target_note {
            note = target_note[0];
            report {
                "note": {
                    "id": note.id,
                    "title": note.title,
                    "content": note.content,
                    "author": note.author,
                    "priority": note.priority
                }
            };
        } else {
            report {"error": "Note not found"};
        }
    }
}
```

#### Update (PUT/PATCH)

```jac
walker update_note {
    has note_id: str;
    has title: str = "";
    has content: str = "";
    has priority: int = 0;

    can modify_note with `root entry {
        target_note = [-->(`?Note)](?id == self.note_id);

        if target_note {
            note = target_note[0];

            if self.title {
                note.title = self.title;
            }
            if self.content {
                note.content = self.content;
            }
            if self.priority > 0 {
                note.priority = self.priority;
            }

            report {"message": "Note updated", "id": note.id};
        } else {
            report {"error": "Note not found"};
        }
    }
}
```

#### Delete (DELETE)

```jac
walker delete_note {
    has note_id: str;

    can remove_note with `root entry {
        target_note = [-->(`?Note)](?id == self.note_id);

        if target_note {
            note = target_note[0];
            del note;
            report {"message": "Note deleted", "id": self.note_id};
        } else {
            report {"error": "Note not found"};
        }
    }
}
```

### Advanced Walker API Patterns

#### Shared Resources

```jac
walker create_shared_note {
    has title: str;
    has content: str;
    has author: str;
    has shared_with: list[str] = [];
    has is_public: bool = false;

    can create_note with `root entry {
        new_note = Note(
            title=self.title,
            content=self.content,
            author=self.author,
            shared_with=self.shared_with,
            is_public=self.is_public,
            id="note_" + str(uuid4())
        );
        here ++> new_note;

        report {
            "message": "Shared note created",
            "id": new_note.id,
            "shared_with": len(self.shared_with),
            "is_public": self.is_public
        };
    }
}

walker get_user_notes {
    obj __specs__ {
        static has auth: bool = False;
        static has methods: list = ["get"];
    }
    has user: str;

    can fetch_accessible_notes with `root entry {
        all_notes = [-->(`?Note)];
        accessible_notes = [];

        for note in all_notes {
            if (note.author == self.user or
                note.is_public or
                self.user in note.shared_with) {
                accessible_notes.append({
                    "id": note.id,
                    "title": note.title,
                    "author": note.author,
                    "is_mine": note.author == self.user
                });
            }
        }

        report {
            "user": self.user,
            "notes": accessible_notes,
            "count": len(accessible_notes)
        };
    }
}

walker share_note {
    has note_id: str;
    has user: str;
    has share_with: str;

    can add_share_permission with `root entry {
        target_note = [-->(`?Note)](?id == self.note_id);

        if target_note {
            note = target_note[0];

            if note.author == self.user {
                if self.share_with not in note.shared_with {
                    note.shared_with.append(self.share_with);
                }

                report {
                    "message": f"Note shared with {self.share_with}",
                    "shared_with": note.shared_with
                };
            } else {
                report {"error": "Only author can share notes"};
            }
        } else {
            report {"error": "Note not found"};
        }
    }
}
```

# Walkers

Walkers are executable agents that traverse and manipulate the graph. They are defined with the `walker` keyword.

## Walker Definition

```jac
walker walker_name {
    // Optional: Declare instance variables
    has field_name: type = default_value;

    // Optional: Define methods
    def method_name(param: type) -> return_type {
        // Method body
    }

    // Required: Define the entry point for execution
    can entry_point_name with `root entry {
        // Walker logic
    }
}
```

## Walker Properties

-   `has field_name: type`: Declares an instance variable for the walker. These can be initialized with default values.

## Walker Methods

-   `def method_name(param: type) -> return_type`: Defines a reusable method within the walker.

## Walker Entry Points

-   `can entry_point_name with `root entry`: Defines the primary execution block for the walker. The code within this block is executed when the walker is spawned.

## Spawning Walkers

Walkers can be spawned on various graph elements.

-   **Spawning on a single node/edge:**
    ```jac
    spawn walker_name(param=value) on node_or_edge;
    ```
-   **Spawning on a list of nodes/edges:**
    ```jac
    spawn walker_name(param=value) on [node1, node2, edge1];
    ```
-   **Asynchronous Spawning:**
    ```jac
    async spawn walker_name(param=value) on node_or_edge;
    ```
    Async walkers enable non-blocking spawns, allowing concurrent execution and efficient handling of I/O-bound operations.

## Walker Operations

### Graph Traversal

-   **Direct Traversal:**
    ```jac
    person1_friends = [person1[0] --> Friend --> Person];
    ```
-   **Filtering during Traversal:**
    ```jac
    cached = [-->(`?WeatherData)](?city == self.city);
    ```
-   **Breadth-First Search (BFS) Example:**
    ```jac
    import from collections { deque }

    walker find_friends_optimized {
        has person_name: str;
        has max_depth: int = 2;

        can breadth_first_search with `root entry {
            start_person = [-->(`?Person)](?name == self.person_name);

            if not start_person {
                report {"error": "Person not found"};
                return;
            }

            queue = deque([(start_person[0], 0)]);  // (person, depth)
            visited = {self.person_name};
            results = set();

            while queue {
                current_person, depth = queue.popleft();

                if depth >= self.max_depth {
                    continue;
                }

                friends = [current_person --> Friend --> Person];

                for friend in friends {
                    if friend.name not in visited {
                        visited.add(friend.name);
                        results.add(friend.name);
                        queue.append((friend, depth + 1));
                    }
                }
            }

            report {
                "person": self.person_name,
                "friends_of_friends": list(results),
                "total_found": len(results),
                "algorithm": "breadth_first"
            };
        }
    }
    ```

### Node and Edge Manipulation

-   **Connecting Nodes:**
    ```jac
    here ++> new_weather; // Connects 'here' node to 'new_weather' node
    person ++> cache;     // Connects 'person' node to 'cache' node
    ```

### Reporting Data

-   `report { "key": value, ... };`: Used to output data from the walker's execution.

### Caching within Walkers

Walkers can implement caching mechanisms by storing computed results as nodes or edges in the graph.

```jac
walker find_friends_cached {
    has person_name: str;
    has max_depth: int = 2;

    can cached_search with `root entry {
        start_person = [-->(`?Person)](?name == self.person_name);

        if not start_person {
            report {"error": "Person not found"};
            return;
        }

        person = start_person[0];

        // Check if we have cached results
        cache_nodes = [person --> CacheEntry](?depth == self.max_depth);

        if cache_nodes {
            cache = cache_nodes[0];
            report {
                "person": self.person_name,
                "friends_of_friends": cache.friend_names,
                "total_found": len(cache.friend_names),
                "cached": true
            };
            return;
        }

        // Compute and cache results (BFS logic omitted for brevity)
        // ...

        // Cache the results
        cache = CacheEntry(
            depth=self.max_depth,
            friend_names=list(results),
            computed_at="2024-01-15"
        );
        person ++> cache;

        report {
            "person": self.person_name,
            "friends_of_friends": list(results),
            "total_found": len(results),
            "cached": false
        };
    }
}
```

### Agent Loops

Walkers can implement agent loops using `while` with `by llm()` for iterative processing or decision-making.

```jac
# Example (conceptual, not directly from input but preserved pattern)
walker agent_loop_example {
    can run_loop with `root entry {
        while condition {
            // Perform actions
            // Make decisions, potentially using by llm()
            // by llm() { "prompt": "What should I do next?" };
            // Update condition
        }
    }
}
```

## System Walkers

Walkers can be used for system-level tasks like health checks and metrics collection.

```jac
walker get_weather {
    has city: str;

    can fetch_weather with `root entry {
        metrics["requests_total"] += 1;
        metrics["requests_per_city"][self.city] = metrics["requests_per_city"].get(self.city, 0) + 1;

        cached = [-->(`?WeatherData)](?city == self.city);

        if cached {
            metrics["cache_hits"] += 1;
            weather = cached[0];
            report {
                "city": weather.city,
                "temperature": weather.temperature,
                "description": weather.description,
                "cached": True
            };
        } else {
            metrics["cache_misses"] += 1;
            new_weather = WeatherData(
                city=self.city,
                temperature=22.5,
                description="Sunny",
                last_updated=datetime.now().isoformat()
            );
            here ++> new_weather;

            report {
                "city": self.city,
                "temperature": 22.5,
                "description": "Sunny",
                "cached": False
            };
        }
    }
}

walker health_check {
    can check_health with `root entry {
        uptime = time() - metrics["start_time"];
        cache_hit_rate = metrics["cache_hits"] / max(metrics["requests_total"], 1) * 100;

        report {
            "status": "healthy",
            "uptime_seconds": uptime,
            "total_requests": metrics["requests_total"],
            "cache_hit_rate_percent": round(cache_hit_rate, 2),
            "cached_cities": len([-->(`?WeatherData)]),
            "timestamp": datetime.now().isoformat()
        };
    }
}

walker metrics_endpoint {
    can get_metrics with `root entry {
        uptime = time() - metrics["start_time"];
        cache_hit_rate = metrics["cache_hits"] / max(metrics["requests_total"], 1) * 100;

        report {
            "uptime_seconds": uptime,
            "total_requests": metrics["requests_total"],
            "cache_hit_rate_percent": round(cache_hit_rate, 2),
            "requests_by_city": metrics["requests_per_city"],
            "timestamp": datetime.now().isoformat()
        };
    }
}
```

## Advanced Walker Features

-   **Intelligent Walker Scheduling:** Supports scheduling across multiple nodes for distributed execution.
-   **Dynamic Runtime Walker Endpoint:** Fixes auto-generated endpoints for walkers created at runtime.
-   **Jac Clouds Traverse API:** Provides an API for controlled graph traversal with parameters:
    -   `source`: Starting node/edge (defaults to `root`).
    -   `detailed`: If response includes archetype context (defaults to `False`).
    -   `depth`: How deep the traversal from source, including edges (defaults to `1`).
    -   `node_types`: Node filter by name (defaults to no filter).
    -   `edge_types`: Edge filter by name (defaults to no filter).

# Walkers

Walkers are executable units in Jac that traverse the graph and perform actions. They can be triggered by various events, including API calls, webhooks, and WebSocket messages.

## Walker Definition

A walker is defined using the `walker` keyword, followed by its name. It can have `has` declarations for parameters and `can` blocks for defining executable entry points or helper methods.

```jac
walker create_chat_room {
    has room_name: str;

    can setup_room with `root entry {
        new_room = ChatRoom(
            name=self.room_name,
            created_at="2024-01-15"
        );
        here ++> new_room;

        report {
            "room_id": new_room.id,
            "name": new_room.name,
            "max_users": chat_config["max_users"]
        };
    }
}
```

## Walker `__specs__`

The `obj __specs__` or `class __specs__` block within a walker defines special properties, such as authentication requirements or how the walker interacts with external systems (e.g., webhooks, WebSockets).

```jac
walker join_room {
    has room_name: str;
    has username: str;

    obj __specs__ {
        static has auth: bool = False; // Example: No authentication required
    }

    can join_chat with `root entry {
        // ... walker logic ...
    }
}
```

## Walker Execution Patterns

### Agent Loops

Walkers can implement agent-like behavior using `while` loops and `by llm()` for iterative processing or decision-making.

```jac
walker send_logged_message {
    has room_name: str;
    has username: str;
    has message: str;

    can send_with_logging with `root entry {
        // Log the attempt
        log_activity(
            level="info",
            message="Message send attempt",
            context={
                "room": self.room_name,
                "user": self.username,
                "message_length": len(self.message)
            }
        ) spawn here; // Spawn another walker

        // Find room
        room = [-->(`?ChatRoom)](?name == self.room_name);

        if not room {
            log_activity(
                level="warning",
                message="Message failed - room not found",
                context={"room": self.room_name, "user": self.username}
            ) spawn here;

            report {"error": "Room not found"};
            return;
        }

        room = room[0];

        // Check if user can send
        if self.username not in room.users {
            log_activity(
                level="warning",
                message="Message failed - user not in room",
                context={"room": self.room_name, "user": self.username}
            ) spawn here;

            report {"error": "User not in room"};
            return;
        }

        // Add message
        new_message = room.add_message(self.username, self.message);

        report {
            "status": "message_sent",
            "message_id": new_message.id,
            "timestamp": new_message.timestamp
        };
    }
}
```

### Spawning Walkers

The `spawn` keyword allows a walker to initiate the execution of another walker.

```jac
log_activity(
    level="info",
    message="Message send attempt",
    context={
        "room": self.room_name,
        "user": self.username,
        "message_length": len(self.message)
    }
) spawn here; // Spawns log_activity walker on the current node
```

## Webhooks

Webhooks allow external services to trigger Jac Cloud walkers. Webhook walkers are linked to the root node and secured with API keys.

### Declaring a Webhook Walker

To declare a walker as a webhook endpoint, add a `webhook` configuration to its `__specs__` class.

```jac
walker webhook {
    can enter1 with `root entry {
        report here;
    }

    class __specs__ {
        has webhook: dict = {
            "type": "header | query | path | body",  // optional: defaults to header
            "name": "any string"                     // optional: defaults to X-API-KEY
        };
    }
}
```

-   `type`: Specifies where the API key is expected (`header`, `query`, `path`, `body`). Defaults to `header`.
-   `name`: Specifies the name of the key (e.g., header name, query parameter name). Defaults to `X-API-KEY`.

### Webhook Walker Example

```jac
walker receive_webhook {
    has source: str = "unknown";
    has event_type: str;
    has data: dict;

    can process_webhook with `root entry {
        // Log the webhook
        webhook_log = WebhookLog(
            source=self.source,
            event_type=self.event_type,
            data=self.data,
            received_at=datetime.now().isoformat()
        );
        here ++> webhook_log;

        // Process different webhook types
        if self.source == "github" and self.event_type == "push" {
            self.handle_github_push();
        } elif self.source == "slack" and self.event_type == "message" {
            self.handle_slack_message();
        } else {
            print(f"Unknown webhook: {self.source}/{self.event_type}");
        }

        report {"status": "webhook_processed", "log_id": webhook_log.id};
    }

    can handle_github_push() {
        // ... logic ...
    }

    can handle_slack_message() {
        // ... logic ...
    }

    can send_to_chat(room_name: str, sender: str, message: str) {
        // ... logic ...
    }
}
```

## WebSockets

Walkers can handle WebSocket connections.

### Declaring a WebSocket Walker

Set the `methods` property to include `"websocket"` in the `__specs__` configuration.

```jac
walker your_event_name {
    has val: int;

    can enter with `root entry {
        report "Do something!";
    }

    class __specs__ {
        has methods: list = ["websocket"];
    }
}
```

**Note**: WebSocket walkers can still work with other HTTP methods but do not support file uploads.

### WebSocket Walker Event Structure (Client-Side)

To trigger a WebSocket walker from a client, send a JSON message with the following structure:

```json
{
    "type": "walker",
    "walker": "your_walker_name",
    "response": true,
    "context": {
        "val": 1
    }
}
```

### Server-Side WebSocket Communication

The `jac_cloud.plugin.WEBSOCKET_MANAGER` (aliased as `socket`) module provides functions for sending messages over WebSockets.

```jac
import from jac_cloud.plugin {WEBSOCKET_MANAGER as socket}

walker send_chat_to_user {
    has root_id: str;

    can enter1 with `root entry {
        _root = &(self.root_id); // Reference operator

        socket.notify_users([_root], {"type": "chat", "data": {"message": "string"}});
    }

    class __specs__ {
        has methods: list = ["websocket", "post"];
    }
}

walker send_chat_to_group {
    has channel_id: str;

    can enter1 with `root entry {
        socket.notify_channels([self.channel_id], {"type": "chat", "data": {"message": "string"}});
    }

    class __specs__ {
        has methods: list = ["websocket", "post"];
    }
}

walker send_chat_to_client {
    has client_id: str;

    can enter1 with `root entry {
        socket.notify_clients([self.client_id], {"type": "chat", "data": {"message": "string"}});
    }

    class __specs__ {
        has methods: list = ["websocket", "post"];
    }
}
```

## Environment Variables

Walkers can access environment variables using the `env()` function.

```jac
walker check_config {
    can enter with `root entry {
        if not env("DATABASE_HOST") {
            print("Warning: DATABASE_HOST not set, using default");
        }
    }
}
```

## Logging

Walkers can perform logging actions, either by creating log entries on the graph or by interacting with the system logger.

```jac
walker log_activity {
    has level: str = "info";
    has message: str;
    has context: dict = {};

    can record_log with `root entry {
        // Create log entry on the graph
        log_entry = LogEntry(
            level=self.level,
            message=self.message,
            timestamp=datetime.now().isoformat(),
            context=self.context
        );
        here ++> log_entry;

        // Also log to system logger
        if self.level == "error" {
            logger.error(f"{self.message} | Context: {self.context}");
        } elif self.level == "warning" {
            logger.warning(f"{self.message} | Context: {self.context}");
        } else {
            logger.info(f"{self.message} | Context: {self.context}");
        }

        report {"log_id": log_entry.id, "logged_at": log_entry.timestamp};
    }
}
```

## Walkers

Walkers are executable units in Jac that can traverse the graph and perform actions. They can be exposed as REST endpoints or scheduled to run periodically.

### Walker Endpoints

Walkers can be automatically converted into REST endpoints. The `__specs__` class within a walker defines its API behavior.

#### Webhook Configuration

The `webhook` dictionary within `__specs__` configures how the API key is expected in the incoming request.

-   **`type`**: Specifies the location of the API key (`"header"`, `"query"`, `"path"`, `"body"`).
-   **`name`**: The name of the header, query parameter, path parameter, or body field containing the API key.
-   **`path`**: (Only for `type: "path"`) Defines the URL path structure, including the path variable.

##### 1. Header for API Key (Default)

```jac
walker webhook_by_header {
    can enter1 with `root entry {
        report here;
    }

    class __specs__ {
        has webhook: dict = {
            "type": "header",
            "name": "test-key"
        };
    }
}
```

**Example Request:**

```bash
curl -X 'POST' 'http://localhost:8001/webhook/walker/webhook_by_header' \
  -H 'test-key: YOUR-GENERATED-KEY'
```

##### 2. Query Parameter for API Key

```jac
walker webhook_by_query {
    can enter1 with `root entry {
        report here;
    }

    class __specs__ {
        has webhook: dict = {
            "type": "query",
            "name": "test_key"
        };
    }
}
```

**Example Request:**

```bash
curl -X 'POST' 'http://localhost:8001/webhook/walker/webhook_by_query?test_key=YOUR-GENERATED-KEY'
```

##### 3. Path Parameter for API Key

```jac
walker webhook_by_path {
    can enter1 with `root entry {
        report here;
    }

    class __specs__ {
        has webhook: dict = {
            "type": "path",
            "name": "test_key"  # name and the path var should be the same
        }, path: str = "/{test_key}";
    }
}
```

**Example Request:**

```bash
curl -X 'POST' 'http://localhost:8001/webhook/walker/webhook_by_path/YOUR-GENERATED-KEY'
```

##### 4. Request Body for API Key

```jac
walker webhook_by_body {
    can enter1 with `root entry {
        report here;
    }

    class __specs__ {
        has webhook: dict = {
            "type": "body",
            "name": "test_key"
        };
    }
}
```

**Example Request:**

```bash
curl -X 'POST' 'http://localhost:8001/webhook/walker/webhook_by_body' -d '{"test_key": "YOUR-GENERATED-KEY"}'
```

#### Walker `__specs__` Properties

-   `has private: bool = True;`: Makes the walker inaccessible via public API endpoints.
-   `obj __specs__ { static has auth: bool = False; }`: Disables authentication for the walker's endpoint.

### Scheduled Walkers

Walkers can be scheduled to run at specific times or intervals by adding a `schedule` dictionary to their `__specs__` configuration.

#### Schedule Configuration

The `schedule` dictionary supports three trigger types: `"cron"`, `"interval"`, and `"date"`.

-   **`trigger`**: (`"cron"`, `"interval"`, `"date"`) Specifies the scheduling mechanism.
-   **`args`**: A list of positional arguments to pass to the walker.
-   **`kwargs`**: A dictionary of keyword arguments to pass to the walker.
-   **`save`**: (`bool`) If `True`, the walker's state will be saved.

##### Cron Trigger

Schedules the walker using cron expressions.

-   **`hour`**: Cron hour expression (e.g., `"0"` for midnight).
-   **`minute`**: Cron minute expression (e.g., `"0"` for on the hour).

```jac
walker walker_cron {
    has arg1: int;
    has arg2: str;
    has kwarg1: int = 3;
    has kwarg2: str = "4";

    can enter with `root entry {
        print("I am a scheduled walker!")
    }

    class __specs__ {
        has private: bool = True;
        has schedule: dict = {
            "trigger": "cron",
            "args": [1, "2"],
            "kwargs": {
                "kwarg1": 30,
                "kwarg2": "40"
            },
            # Run every day at midnight
            "hour": "0",
            "minute": "0",
            "save": True
        };
    }
}
```

##### Interval Trigger

Schedules the walker at regular time intervals.

-   **`seconds`**: Interval in seconds. Other units like `minutes`, `hours`, `days`, `weeks` are also supported.

```jac
walker walker_interval {
    has arg1: int;
    has arg2: str;
    has kwarg1: int = 3;
    has kwarg2: str = "4";

    can enter with `root entry {
        print("I am a scheduled walker running every 5 seconds!");
    }

    class __specs__ {
        has private: bool = True;
        has schedule: dict = {
            "trigger": "interval",
            "args": [1, "2"],
            "kwargs": {
                "kwarg1": 30,
                "kwarg2": "40"
            },
            "seconds": 5,
            "save": True
        };
    }
}
```

##### Date Trigger

Schedules the walker to run once at a specific date and time.

-   **`run_date`**: The specific date and time in ISO 8601 format (e.g., `"2025-04-30T11:12:00+00:00"`).

```jac
walker walker_date {
    has arg1: int;
    has arg2: str;
    has kwarg1: int = 3;
    has kwarg2: str = "4";

    can enter with `root entry {
        print("I am a scheduled walker running once at a specific time!");
    }

    class __specs__ {
        has private: bool = True;
        has schedule: dict = {
            "trigger": "date",
            "args": [1, "2"],
            "kwargs": {
                "kwarg1": 30,
                "kwarg2": "40"
            },
            "run_date": "2025-04-30T11:12:00+00:00",
            "save": True
        };
    }
}
```

### Walker Examples

#### Task Creation

```jac
walker get_or_create_counter {
    can enter1 with `root entry {
        tc = TaskCounter();
        here ++> tc;

        report tc;
    }

    can enter2 with TaskCounter entry {
        report here;
    }
}

walker increment_counter {
    has val: int;

    can enter with TaskCounter entry {
        here.val += self.val;
    }

    class __specs__ {
        has private: bool = True;
    }
}

walker trigger_counter_task {
    can enter with `root entry {
        tcs = [-->(`?TaskCounter)];
        if tcs {
            report create_task(increment_counter(val=1), tcs[0]);
        }
    }
}
```

#### Note Management

```jac
walker create_note {
    has title: str;
    has content: str;
    has owner: str;
    has is_public: bool = False;

    obj __specs__ {
        static has auth: bool = False;
    }

    can add_note with `root entry {
        new_note = Note(
            title=self.title,
            content=self.content,
            owner=self.owner,
            is_public=self.is_public
        );
        here ++> new_note;

        report {
            "status": "created",
            "note_id": new_note.id,
            "public": new_note.is_public
        };
    }
}

walker get_my_notes {
    has user_id: str;

    can fetch_user_notes with `root entry {
        my_notes = [-->(`?Note)](?owner == self.user_id);

        notes_data = [
            {"id": n.id, "title": n.title, "created_at": n.created_at}
            for n in my_notes
        ];

        report {"notes": notes_data, "total": len(notes_data)};
    }
}

walker list_my_notes {
    has user_id: str;

    obj __specs__ {
        static has auth: bool = False;
    }

    can get_user_notes with `root entry {
        user_notes = [-->(`?Note)](?owner == self.user_id);

        report {
            "user": self.user_id,
            "notes": [
                {
                    "id": n.id,
                    "title": n.title,
                    "private": n.is_private
                }
                for n in user_notes
            ],
            "count": len(user_notes)
        };
    }
}

walker share_note {
    has note_id: str;
    has current_user: str;
    has target_user: str;
    has permission_level: str = "read";  # "read" or "write"

    obj __specs__ {
        static has auth: bool = False;
    }

    can add_sharing_permission with `root entry {
        target_note = [-->(`?Note)](?id == self.note_id);

        if not target_note {
            report {"error": "Note not found"};
            return;
        }

        note = target_note[0];

        if note.owner != self.current_user {
            report {"error": "Only note owner can share"};
            return;
        }

        if self.target_user not in note.shared_with {
            note.shared_with.append(self.target_user);
        }

        report {
            "message": f"Note shared with {self.target_user}",
            "permission": self.permission_level,
            "shared_count": len(note.shared_with)
        };
    }
}
```

#### Permission Management

-   `_.allow_root(node, NodeAnchor.ref(root_id), access_level)`: Grants a specific root access to a node.
-   `_.disallow_root(node, NodeAnchor.ref(root_id))`: Revokes a specific root's access to a node.
-   `grant(node, permission)`: Grants a permission (e.g., `ReadPerm`) to all users for a node.
-   `revoke(node)`: Revokes all permissions for a node, making it private to the owner.

```jac
walker grant_access {
    has target_root_id: str;  # ID of User2's root
    has access_level: str;    # ReadPerm, ConnectPerm, or WritePerm

    can grant_access with post entry {
        _.allow_root(here, NodeAnchor.ref(self.target_root_id), self.access_level);
        report "Access granted!";
    }
}

walker revoke_access {
    has target_root_id: str;  # ID of User2's root

    can revoke_access with post entry {
        _.disallow_root(here, NodeAnchor.ref(self.target_root_id));
        report "Access revoked!";
    }
}

walker make_public {
    can make_public with post entry {
        grant(here, ReadPerm);
        report "Post is now public!";
    }
}

walker make_private {
    can make_private with post entry {
        revoke(here);
        report "Post is now private!";
    }
}

walker create_public_post {
    has content: str;

    can enter with `root entry {
        post = Post({content: self.content});
        here ++> post;

        grant(post, ReadPerm);

        report "Public post created!";
    }
}

walker grant_team_access {
    has team_members: list[str];  # List of root IDs
    has access_level: str;        # ReadPerm, ConnectPerm, or WritePerm

    can grant_access with document entry {
        for member_id in self.team_members {
            _.allow_root(here, NodeAnchor.ref(member_id), self.access_level);
        }

        report "Team access granted!";
    }
}

walker check_access {
    has viewer_id: str;

    can check with post entry {
        owner = [post<--][0];

        is_friend = False;
        for friend in [owner -->] {
            if friend.id == self.viewer_id {
                is_friend = True;
                break;
            }
        }

        if is_friend {
            _.allow_root(here, NodeAnchor.ref(self.viewer_id), "READ");
            report "Access granted to friend!";
        } else {
            report "Access denied - not a friend!";
        }
    }
}
```

## Walkers

Walkers are executable agents that traverse and manipulate graph structures. They can also be exposed as REST API endpoints.

### Walker Declaration

```jac
walker MyWalker {
    has field_name: type = default_value;

    can ability_name with `event_clause {
        // Walker logic
    }
}
```

-   `async walker`: Declares an asynchronous walker. These execute in a separate thread, returning immediately with a `walker_id`.
    ```jac
    async walker sample {
        has value: int = 0;

        can enter with `root entry {
            print("test");
            self.value = 1;
        }
    }
    ```

### Walker Abilities

Abilities define actions a walker can perform. They can be named or anonymous.

-   **Named Ability**:
    ```jac
    can entry1 with entry {
        print("walker entry");
    }
    ```
-   **Anonymous Ability**:
    ```jac
    can with entry {
        // Logic for an anonymous entry ability
    }
    ```

#### Event Clauses

Abilities are triggered by specific events during a walker's lifecycle or traversal.

-   `entry`: Executed when the walker enters a node.
-   `exit`: Executed when the walker exits a node.
-   `` `root entry ``: Executed when the walker starts its traversal from the root node.
-   `` `Node entry ``: Executed when the walker enters any node.
-   `` `Node exit ``: Executed when the walker exits any node.

### Spawning Walkers

Walkers can be spawned on nodes, lists of nodes, or lists of edges.

-   **Spawn on a single node**:
    ```jac
    spawn Walker on node_instance;
    ```
-   **Spawn on a list of nodes**:
    ```jac
    spawn Walker on [node1, node2];
    ```
-   **Spawn on a list of edges**:
    ```jac
    spawn Walker on [edge1, edge2];
    ```

### Walker Properties

-   `self.value`: Accesses the current node's value during traversal.
-   `here`: Refers to the current node the walker is on.
-   `.edges`: Property of a node to access its connected edges.

### Walker Persistence

-   `save(walker_instance)`: Saves a walker instance to memory, queued for database commit.
-   `load(walker_id)`: Loads a walker instance by its ID.

### Asynchronous Walkers

Asynchronous walkers (`async walker`) execute in a separate thread and return a `walker_id` immediately.

#### Response Format for Async Walkers

```json
{
  "status": 200,
  "walker_id": "w:sample:550e8400-e29b-41d4-a716-446655440000"
}
```

#### Retrieving Async Walker Results

```jac
walker view_sample_result {
    has walker_id: str;

    can enter with `root entry {
        wlk = &walker_id; // Get a reference to the walker instance

        print(wlk.value); // Access walker's attributes
        schedule_info = wlk.__jac__.schedule; // Access execution metadata

        print(f"Status: {schedule_info.status}");
        if schedule_info.error{
            print(f"Error: {schedule_info.error}");
        }
    }
}
```

#### `__jac__.schedule` Object

Contains execution metadata for async walkers.

| Field           | Description                                                |
| :-------------- | :--------------------------------------------------------- |
| `status`        | Current execution status (pending, running, completed, failed) |
| `node_id`       | ID of the node where the walker was executed                   |
| `root_id`       | ID of the root node of the user who triggered the walker       |
| `execute_date`  | When the walker was scheduled to execute                       |
| `executed_date` | When the walker actually executed                              |
| `http_status`   | HTTP status code for the execution result                      |
| `reports`       | Any values reported during walker execution                    |
| `custom`        | Custom metadata associated with the walker                     |
| `error`         | Error message if execution failed                              |

### Walker Endpoints (REST API)

Jac Cloud automatically converts walker declarations into REST API endpoints.

#### Default Endpoint Generation

| Endpoint Type | URL Pattern                  | Description             |
| :------------ | :--------------------------- | :---------------------- |
| **Root Entry** | `/walker/{walker_name}`      | Executes on the root    |
| **Node Entry** | `/walker/{walker_name}/{node_id}` | Executes on a specific node |

#### Disabling Auto-Endpoint Generation

Set the environment variable:
```bash
export DISABLE_AUTO_ENDPOINT=True
```

#### `__specs__` Object for Endpoint Configuration

Control endpoint behavior using the `__specs__` object within your walker.

```jac
walker my_walker {
    has data: str;

    obj __specs__ {
        static has methods: list = ["get", "post"];
        static has auth: bool = False;
        static has as_query: list = ["data"];
        static has private: bool = True;
    }
}
```

##### `__specs__` Settings

| Setting     | Type                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

# Walkers

Walkers are "worker bots" that move (walk) along the graph while performing tasks on the nodes they visit. They are archetypes that perform actions within the graph, traversing nodes through edges and executing operations at each step. Walkers are the orchestrators that coordinate task flow and decision-making across agents in agentic systems.

## Walker Definition

Walkers can have their own attributes (`has`) and abilities (`can`), similar to nodes.

```jac
walker walker_name {
  can walker_ability with `specific_node entry;
}
```

### Visit-Dependent Abilities

These abilities are triggered only when a walker visits a node. They can be defined within:
-   **Nodes:** Triggered upon a walker's arrival.
-   **Walkers:** Specific to the walkers operation during its visit.

Walkers prioritize their visit-dependent abilities first before executing the abilities of the visited node.

### Special Keywords

-   `self`: Refers to the walker object itself.
-   `here`: References the current node visited by the walker, enabling access to its attributes and callable abilities.

### Node Abilities Triggered by Walkers

Nodes can define abilities that are triggered when a specific type of walker interacts with them. The `here` keyword within these abilities refers to the visiting walker.

```jac
node test_node {
    has value: int;

    can log_entry with entry {
        print(f">>> Some Walker entered the node: ", self);
    }
    can log_test_walker_entry with test_walker entry {
        print(f">>> {here} entered the node {self}");
        here.callable();
    }
    can log_test_walker_exit with test_walker exit {
        print(f"<<< {here} exited the node {self}");
    }
    can log_exit with exit {
        print(f"<<< Some Walker exited the node {self}");
    }
    def callable {
        print(f"===== Callable on {self}");
    }
}
```

### Walker Entry/Exit/Visit Abilities

Walkers can define special visit-dependent abilities:

-   `can <name> with entry`: Triggered once when the walker is spawned, before visiting any nodes.
-   `can <name> with <node_type> entry`: Executed each time the walker visits a node of the specified type.
-   `can <name> with exit`: Triggered once when the walker finishes its traversal.

## Spawning Walkers

A walker can be spawned at any point on the graph using the `spawn` keyword.

```jac
with entry {
  root spawn walker_name();
}
```

### Spawning on a specific node

```jac
routed_node = here ++> node_type();  # Create if doesn't exist
self.cur_task = subtask;  # Pass subtask to agent
visit routed_node;  # Trigger agent's can execute ability
```

## Graph Traversal

Walkers navigate the graph using the `visit` keyword.

-   `visit [node_name];`: Visits a particular node.
-   `visit [node_name-->];`: Visits successive nodes of a node.
-   `visit [<--node_name];`: Visits predecessor nodes of a node.

### Example Traversal Patterns

```jac
walker visit_profile {
    can visit_profile with `root entry;
}

impl visit_profile.visit_profile {
    visit [-->(`?Profile)] else {
        new_profile = here ++> Profile();
        grant(new_profile[0], level=ConnectPerm);
        visit new_profile;
    }
}
```

```jac
walker load_feed(visit_profile) {
    has search_query: str = "";
    has results: list = [];
    can load with Profile entry;
}

impl load_feed.load {
    visit [-->(`?Tweet)];
    for user_node in [->:Follow:->(`?Profile)] {
        visit [user_node-->(`?Tweet)];
    }
    report self.results;
}
```

## Walker Inheritance and Overriding

Walkers can inherit from other walkers and override their abilities.

```jac
walker walker_1{
}
walker walker_2 : walker_1:{
}
```

To override an ability:

```jac
walker walker_1{
  can ability_1 with `root entry{
      print("write");
  }
}
walker walker_2 : walker_1:{
  override can ability_1 with `root entry{
      print("override");
  }
}
```

## Walker Control

-   `disengage`: Removes a walker from the graph.

## Agentic Systems with Walkers

Walkers serve as the execution engine and orchestrators in agentic systems. They coordinate multi-agent systems by traversing the graph and visiting nodes.

### Orchestrator Walker Example

```jac
walker task_manager {
  has utterance: str = "";
  has cur_task: TaskPartition = None;

  def route_to_node(utterance: str) -> RoutingNodes by llm();
  def plan_tasks(main_task: str) -> list[TaskPartition] by llm();

  can execute with `root entry {
    # Step 1: Plan - decompose the user's request
    subtasks = self.plan_tasks(self.utterance);
    print("[Planned Subtasks]:", subtasks);

    # Step 2: Map agent types to node classes
    node_map = {
      RoutingNodes.TASK_HANDLING: TaskHandling,
      RoutingNodes.EMAIL_HANDLING: EmailHandling,
      RoutingNodes.GENERAL_CHAT: GeneralChat
    };

    # Step 3: Execute - route and visit each agent
    for subtask in subtasks {
      node_type = node_map[subtask.agent_type];
      routed_node = [-->(`?node_type)];  # Check if agent exists
      if not routed_node {
        routed_node = here ++> node_type();  # Create if doesn't exist
      }
      self.cur_task = subtask;  # Pass subtask to agent
      visit routed_node;  # Trigger agent's can execute ability
    }
  }
}
```

## Walker-based REST APIs

Jac automatically converts walkers into REST APIs.

-   Walker fields (`has` variables) become the API interface.
-   An additional `target_node` field specifies where to spawn the walker.

### API Endpoints

-   `GET /walkers`: List all available walkers.
-   `GET /walker/<name>`: Get field information for a specific walker.
    -   **Response Example:**
        ```json
        {
          "name": "CreateTask",
          "info": {
            "fields": {
              "title": {
                "type": "str",
                "required": true,
                "default": null
              },
              "priority": {
                "type": "int",
                "required": false,
                "default": "1"
              },
              "target_node": {
                "type": "str (node ID, optional)",
                "required": false,
                "default": "root"
              }
            }
          }
        }
        ```
-   `POST /walker/<name>`: Spawn a walker with provided fields.
    -   **Request Body Example:**
        ```json
        {
          "fields": {
            "title": "Buy groceries",
            "priority": 2,
            "target_node": "optional-node-id"
          }
        }
        ```
    -   **Response Example:**
        ```json
        {
          "result": "Walker executed successfully",
          "reports": []
        }
        ```

The `target_node` field is optional and defaults to the user's root node. If specified, it must be a valid node ID (hex string). All walker execution happens in the context of the authenticated user.