# API and REST

# API and REST Reference

## Jac Serve: Automatic API Generation

The `jac serve` command transforms Jac programs into authenticated REST APIs.

### Usage
```bash
jac serve main.jac
```
Your application will be available at `http://localhost:8000` with automatic API documentation at `http://localhost:8000/docs`.

### Features
-   **Instant API Generation**: Automatically converts Jac walkers and functions into REST endpoints.
-   **HTTP Methods**: Supports all HTTP methods (GET, POST, PUT, DELETE, etc.).
-   **OpenAPI/Swagger**: Built-in documentation at `/docs`.
-   **User Management**: Creates a user management system with persistent root nodes for each user.
-   **Authentication**: Token-based authentication for protected endpoints.
-   **CORS Support**: Includes CORS headers for web application integration.

### API Endpoints

#### Public Endpoints (No Authentication Required)

-   **`GET /`**
    -   Returns API information and available endpoints.
    ```bash
    curl http://localhost:8000/
    ```

-   **`POST /user/create`**
    -   Creates a new user account. Each user gets their own persistent root node.
    -   **Request Body:**
        ```json
        {
          "username": "alice",
          "password": "secret123"
        }
        ```
    -   **Response:**
        ```json
        {
          "username": "alice",
          "token": "abc123...",
          "root_id": "uuid-of-root-node"
        }
        ```
    ```bash
    curl -X POST http://localhost:8000/user/create \
      -H "Content-Type: application/json" \
      -d '{"username": "alice", "password": "secret123"}'
    ```

-   **`POST /user/login`**
    -   Authenticates and receives a token.
    -   **Request Body:**
        ```json
        {
          "username": "alice",
          "password": "secret123"
        }
        ```
    -   **Response:**
        ```json
        {
          "username": "alice",
          "token": "abc123...",
          "root_id": "uuid-of-root-node"
        }
        ```
    ```bash
    curl -X POST http://localhost:8000/user/login \
      -H "Content-Type: application/json" \
      -d '{"username": "alice", "password": "secret123"}'
    ```

#### Protected Endpoints (Authentication Required)

All protected endpoints require an `Authorization` header with a Bearer token:
`Authorization: Bearer YOUR_TOKEN_HERE`

-   **`GET /functions`**
    -   Lists all available functions in the module.
    ```bash
    curl http://localhost:8000/functions \
      -H "Authorization: Bearer YOUR_TOKEN"
    ```
    -   **Response:**
        ```json
        {
          "functions": ["add_numbers", "greet", "calculate_stats"]
        }
        ```

-   **`GET /function/<name>`**
    -   Gets the signature and parameter information for a specific function.
    ```bash
    curl http://localhost:8000/function/add_numbers \
      -H "Authorization: Bearer YOUR_TOKEN"
    ```
    -   **Response:**
        ```json
        {
          "name": "add_numbers",
          "signature": {
            "parameters": {
              "a": {
                "type": "int",
                "required": true,
                "default": null
              },
              "b": {
                "type": "int",
                "required": true,
                "default": null
              }
            },
            "return_type": "int"
          }
        }
        ```

-   **`POST /function/<name>`**
    -   Calls a function with the provided arguments.
    -   **Request Body:**
        ```json
        {
          "args": {
            "a": 5,
            "b": 10
          }
        }
        ```
    -   **Response:**
        ```json
        {
          "result": 15,
          "reports": []
        }
        ```
    ```bash
    curl -X POST http://localhost:8000/function/add_numbers \
      -H "Authorization: Bearer YOUR_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"args": {"a": 5, "b": 10}}'
    ```

-   **`GET /walkers`**
    -   Lists all available walkers in the module.
    ```bash
    curl http://localhost:8000/walkers \
      -H "Authorization: Bearer YOUR_TOKEN"
    ```
    -   **Response:**
        ```json
        {
          "walkers": ["CreateTask", "ListTasks", "CompleteTask"]
        }
        ```

-   **`GET /walker/<name>`**
    -   Gets the field information for a specific walker.
    ```bash
    curl http://localhost:8000/walker/CreateTask \
      -H "Authorization: Bearer YOUR_TOKEN"
    ```
    -   **Response:**
        ```json
        {
          "name": "CreateTask",
          "info": {
            "fields": {
              "title": {
                "type": "str",
                "required": true,
                "default": null
              },
              "priority": {
                "type": "int",
                "required": false,
                "default": "1"
              },
              "target_node": {
                "type": "str (node ID, optional)",
                "required": false,
                "default": "root"
              }
            }
          }
        }
        ```

-   **`POST /walker/<name>`**
    -   Spawns a walker with the provided fields.
    -   **Request Body:**
        ```json
        {
          "fields": {
            "title": "Buy groceries",
            "priority": 2,
            "target_node": "optional-node-id"
          }
        }
        ```
    -   **Response:**
        ```json
        {
          "result": "Walker executed successfully",
          "reports": []
        }
        ```
    ```bash
    curl -X POST http://localhost:8000/walker/CreateTask \
      -H "Authorization: Bearer YOUR_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{"fields": {"title": "Buy groceries", "priority": 2}}'
    ```

### Example API Call Function
```jac
def make_api_call(token: str, endpoint: str, payload: dict) -> dict {
    response = requests.post(
        "http://localhost:8000/" + endpoint,
        json=payload,
        headers={"Authorization": "Bearer " + token}
    );
    return response.json() if response.status_code == 200 else {};
}
```

## Single Sign-On (SSO) Callback Endpoint

JAC Cloud provides a callback endpoint for SSO registration.

### Endpoint Format
`GET {backendURL}/sso/${provider}/register/callback?id_token=${id_token}`

### Supported Providers
| Platform            | Provider Value   |
| :------------------ | :--------------- |
| Apple (any platform)| `apple`          |
| Google Web          | `google`         |
| Google Android      | `google_android` |
| Google iOS          | `google_ios`     |

### Example Calls
```bash
# For Apple Sign-In
curl "${backendURL}/sso/apple/register/callback?id_token=${id_token}"

# For Google Web
curl "${backendURL}/sso/google/register/callback?id_token=${id_token}"

# For Google Android
curl "${backendURL}/sso/google_android/register/callback?id_token=${id_token}"

# For Google iOS
curl "${backendURL}/sso/google_ios/register/callback?id_token=${id_token}"
```

## Language Model (LLM) Integration

### LiteLLM Proxy Integration
Use `byllm.lib.Model` to connect to a LiteLLM proxy server.
```python
from byllm.lib import Model

llm = Model(
    model_name="gpt-4o",                # The model name to be used
    api_key="your_litellm_api_key",     # LiteLLM proxy server key
    proxy_url="http://localhost:8000",  # URL of the LiteLLM proxy server
)
```
The `api_key` is for the LiteLLM proxy, not the OpenAI API key.

### Custom LLM Model Class
To bypass LiteLLM and use a custom API or self-hosted model, extend `byllm.llm.BaseLLM`.

#### Python Example
```python linenums="1"
from byllm.llm import BaseLLM
from openai import OpenAI

class MyOpenAIModel(BaseLLM):
    def __init__(self, model_name: str, **kwargs: object) -> None:
        """Initialize the MockLLM connector."""
        super().__init__(model_name, **kwargs)

    def model_call_no_stream(self, params):
        client = OpenAI(api_key=self.api_key)
        response = client.chat.completions.create(**params)
        return response

    def model_call_with_stream(self, params):
        client = OpenAI(api_key=self.api_key)
        response = client.chat.completions.create(stream=True, **params)
        return response
```

#### Jac Example
```jac linenums="1"
import from byllm.llm { BaseLLM }
import from openai { OpenAI }

obj  MyOpenAIModel(BaseLLM){
    has model_name: str;
    has config: dict = {};

    def post_init() {
        super().__init__(model_name=self.model_name, **kwargs);
    }

    def model_call_no_stream(params: dict) {
        client = OpenAI(api_key=self.api_key);
        response = client.chat.completions.create(**params);
        return response;
    }

    def model_call_with_stream(params: dict) {
        client = OpenAI(api_key=self.api_key);
        response = client.chat.completions.create(stream=True, **params);
        return response;
    }
}
```

### OpenAI API Key Configuration
For applications using OpenAI services:
```bash
export OPENAI_API_KEY="your-api-key-here"
```
For Kubernetes deployments, encode the key and update `jac-cloud.yml`:
```bash
echo -n "your-openai-key" | base64
```
Then apply:
```bash
kubectl apply -f jac-cloud/scripts/jac-cloud.yml
```
The `OPENAI_API_KEY` variable will be set from the secret.

## Streamlit API Access

Jac applications can utilize all Streamlit components and features.
```jac
import streamlit as st;
import pandas as pd;
import numpy as np;

with entry {
    st.title("Data Dashboard");

    # Create sample data
    data = pd.DataFrame({
        'x': np.random.randn(100),
        'y': np.random.randn(100)
    });

    # Display chart
    st.line_chart(data);

    # Add sidebar
    st.sidebar.header("Controls");
    chart_type = st.sidebar.selectbox("Chart Type", ["line", "bar", "area"]);

    if chart_type == "bar" {
        st.bar_chart(data);
    } elif chart_type == "area" {
        st.area_chart(data);
    }
}
```