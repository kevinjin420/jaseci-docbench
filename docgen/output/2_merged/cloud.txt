# Cloud and Deployment

# Cloud and Deployment

Jac Cloud is a cloud-native framework for deploying Jac applications as production-ready API servers. It provides features like Kubernetes deployment, Docker containerization, ConfigMap-based configuration, and horizontal scaling.

## Deployment to Kubernetes

Jac Cloud provides a Kubernetes-based deployment template.

### Prerequisites

*   Kubernetes Cluster access
*   `kubectl` installed and configured
*   Docker installed
*   Target Kubernetes namespace created
*   OpenAI API Key (optional, for OpenAI services)

### Directory Structure

```
jac-cloud/
├── scripts/
│   ├── Dockerfile
│   ├── init_jac_cloud.sh
│   ├── jac-cloud.yml
│   ├── module-config.yml
```

### Step-by-Step Deployment

1.  **Build and Push Docker Image:**
    ```bash
    docker build -t your-dockerhub-username/jac-cloud:latest -f jac-cloud/scripts/Dockerfile .
    docker push your-dockerhub-username/jac-cloud:latest
    ```
    Update the `image` field in `jac-cloud.yml` with your Docker image path.

2.  **Apply ConfigMap:**
    ```bash
    kubectl apply -f jac-cloud/scripts/module-config.yml
    ```
    This creates the `littlex` namespace and configures module settings.

3.  **Apply Kubernetes Resources:**
    ```bash
    kubectl apply -f jac-cloud/scripts/jac-cloud.yml
    ```
    This sets up RBAC roles, bindings, and the Jac Cloud deployment in the `littlex` namespace.

4.  **Add OpenAI API Key (Optional):**
    Encode your API key:
    ```bash
    echo -n "your-openai-key" | base64
    ```
    Update the `data.openai-key` field in the secret definition within `jac-cloud.yml` and apply:
    ```bash
    kubectl apply -f jac-cloud/scripts/jac-cloud.yml
    ```

5.  **Verify Deployment:**
    ```bash
    kubectl get all -n littlex
    ```
    Confirm the Jac Cloud pod and associated resources are running.

### Configuration Details

#### Environment Variables

| Variable         | Description                         | Default Value   |
| :--------------- | :---------------------------------- | :-------------- |
| `NAMESPACE`      | Target namespace for the deployment | `default`       |
| `CONFIGMAP_NAME` | Name of the ConfigMap to mount      | `module-config` |
| `FILE_NAME`      | JAC file to execute in the pod      | `example.jac`   |
| `OPENAI_API_KEY` | OpenAI API key (from secret)        | None            |

### Troubleshooting and Validation

*   **Verify Namespace:** `kubectl get namespaces`
*   **Verify ConfigMap:** `kubectl get configmap -n littlex`
*   **Verify Deployment:** `kubectl get pods -n littlex`

### Advanced Usage

*   **Updating Configurations:** Modify YAML files and re-apply:
    ```bash
    kubectl apply -f jac-cloud/scripts/module-config.yml
    kubectl apply -f jac-cloud/scripts/jac-cloud.yml
    ```
*   **Monitoring Logs:**
    ```bash
    kubectl logs -f deployment/jac-cloud -n littlex
    ```
*   **Scaling Deployment:**
    ```bash
    kubectl scale deployment jac-cloud --replicas=3 -n littlex
    ```
*   **Configuring Resource Limits:** Adjust `resources` in `jac-cloud.yml`:
    ```yaml
    resources:
      limits:
        cpu: "1"
        memory: "1Gi"
      requests:
        cpu: "500m"
        memory: "512Mi"
    ```

### Cleanup

To remove all deployed resources:
```bash
kubectl delete namespace littlex
```

## Single Sign-On (SSO)

Jac Cloud supports SSO integration with various platforms.

### Supported Platforms

| Platform name    | Used for                                         |
| :--------------- | :----------------------------------------------- |
| `APPLE`          | Apple SSO for websites and mobile apps           |
| `GOOGLE`         | Gmail SSO for websites                           |
| `GOOGLE_ANDROID` | Gmail SSO for Android mobile apps                |
| `GOOGLE_IOS`     | Gmail SSO for iOS mobile apps                    |

### Implementation Steps

1.  **Obtain Client Credentials:** Register your application with the chosen platform to get necessary credentials.
2.  **Call Register Callback Endpoint:** After obtaining the `id_token`, call the Jac Cloud callback endpoint. This registers the user and returns user information (name, email, etc.).

## Streamlit Integration

Jac Cloud APIs can be integrated with Streamlit frontends.

```jac
import streamlit as st;
import requests;

def make_api_call(token: str, endpoint: str, payload: dict) -> dict {
    response = requests.post(
        "http://localhost:8000/" + endpoint,
        json=payload,
        headers={"Authorization": "Bearer " + token}
    );
    return response.json() if response.status_code == 200 else {};
}

with entry {
    st.title("Jac Cloud Frontend");

    # Authentication
    if "token" not in st.session_state {
        st.session_state.token = None;
    }

    if not st.session_state.token {
        with st.form("login_form") {
            email = st.text_input("Email");
            password = st.text_input("Password", type="password");

            if st.form_submit_button("Login") {
                // Attempt login
                response = requests.post(
                    "http://localhost:8000/user/login",
                    json={"email": email, "password": password}
                );

                if response.status_code == 200 {
                    st.session_state.token = response.json()["token"];
                    st.rerun();
                } else {
                    st.error("Login failed!");
                }
            }
        }
    } else {
        st.success("Logged in successfully!");

        // Your app content here
        user_input = st.text_input("Enter your message:");

        if st.button("Send") and user_input {
            result = make_api_call(
                st.session_state.token,
                "walker/interact",
                {"message": user_input}
            );

            if result {
                st.write("Response:", result);
            }
        }
    }
}
```

## Dependencies

To use Jac Cloud, install the necessary packages:

```bash
pip install jac-streamlit requests jaclang jac-cloud byllm
```

## Running a Jac Cloud Server

To start a Jac Cloud server for a Jac file:

```bash
jac serve task_manager.jac
```