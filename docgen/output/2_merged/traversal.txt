# Graph Traversal

# Graph Traversal

Graph traversal in Jac involves navigating nodes and edges using walkers.

## Walker Navigation Keywords

| Keyword      | Description                                                              |
| :----------- | :----------------------------------------------------------------------- |
| `visit`      | Directs a walker to traverse to a node or edge.                          |
| `spawn`      | Creates and starts a walker on a graph.                                  |
| `ignore`     | Excludes a node or edge from a walker's traversal.                       |
| `disengage`  | Immediately terminates a walker's traversal.                             |
| `report`     | Sends a result from a walker back to its spawning context.               |
| `with entry` | Defines the main execution block for a module or walker entry/exit points. |

## Walker Lifecycle Abilities

Walkers can define special abilities that trigger at different points in their lifecycle:

-   `can <ability_name> with entry`: Triggered once when the walker is spawned, before visiting any nodes.
-   `can <ability_name> with <node_type> entry`: Triggered each time the walker enters a node of the specified type.
-   `can <ability_name> with <node_type> exit`: Triggered each time the walker exits a node of the specified type.
-   `can <ability_name> with exit`: Triggered once when the walker finishes its traversal.

```jac
    can start with `root entry {
        print("Starting journey!");
        visit [-->];
    }

    can greet with Person entry {
        print(f"Hello, {here.name}!");
        self.greeting_count += 1;
        visit [-->];
    }
```

## `visit` Statement Syntax

The `visit` statement is used to control walker movement.

```jac
// Visit all outgoing edges from the current node
visit [-->];

// Visit a particular node by name
visit [node_name];

// Visit successive nodes of a node
visit [node_name-->];

// Visit predecessor nodes of a node
visit [<--node_name];

// Visit only edges of a specific type
visit [edge ->:Family :->];

// Visit nodes matching a specific archetype
visit [-->(`?WeatherData)];

// Visit nodes matching an archetype with a filter
visit [-->(`?WeatherData)](?city == self.city);
```

## Spawning Walkers

Walkers can be spawned on individual nodes/edges or lists of nodes/edges.

```jac
spawn my_walker on my_node;
spawn my_walker on [node1, node2, edge3];
```

## Filtering Traversal

JacLang provides mechanisms to filter nodes and edges during traversal.

### Node-Based Filtering

Restricts traversal to specific nodes based on conditions.

```jac
                cached = [-->(`?WeatherData)](?city == self.city);
```

### Edge-Based Filtering

Controls traversal by selecting edges based on attributes or conditions.

## Library Mode Traversal (`jaclang.lib`)

For Python interoperability, `jaclang.lib` provides `visit`, `refs`, and `OPath` for constructing traversal paths.

```python
from jaclang.lib import visit, refs, OPath

# Visit all outgoing edges
visit(self, refs(OPath(here).edge_out().visit()))

# Visit only Family edges
visit(
    self, refs(OPath(here).edge_out(edge=lambda i: isinstance(i, Family)).edge().visit())
)
```

### `OPath` Class

Object-spatial path builder.

-   `OPath(node)`: Creates a path from a given `node`. Returns `ObjectSpatialPath`.
-   `.edge_out(edge, node)`: Filters outgoing edges. Chainable.
-   `.edge_in(edge, node)`: Filters incoming edges. Chainable.
-   `.edge_any(edge, node)`: Filters edges in any direction. Chainable.
-   `.edge()`: Filters the path to include only edges (no nodes). Chainable.
-   `.visit()`: Marks the constructed path for walker traversal. Chainable.

## Jac Clouds Traverse API

The Jac Clouds Traverse API allows for graph traversal via HTTP endpoints.

### `GET /util/traverse`

Performs a graph traversal and returns the complete result.

#### Query Parameters

| Name         | Type      | Description                                                                                                                                                                              | Default Value       |
| :----------- | :-------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------ |
| `source`     | `string`  | The **JID** of the starting root, node, or edge for the traversal.                                                                                                                       | Current user's root |
| `detailed`   | `boolean` | If `true`, the response will include the archetype's context for each traversed item.                                                                                                    | `false`             |
| `depth`      | `integer` | The maximum number of steps to traverse. Both nodes and edges are considered one step.                                                                                                   | `1`                 |
| `node_types` | `string`  | Can be declared multiple times to filter the traversal results by node type. For example, `node_types=Node1&node_types=Node2` will include only nodes that are `Node1` or `Node2` types. | All node types      |
| `edge_types` | `string`  | Can be declared multiple times to filter the traversal results by edge type. For example, `edge_types=Edge1&edge_types=Edge2` will include only edges that are `Edge1` or `Edge2` types. | All edge types      |

#### Sample Request

```bash
curl -X GET "/util/traverse?source=n::68875f383d1e672f517094ff&detailed=true&depth=2&node_types=Node1&node_types=Node2&edge_types=Edge1" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### `GET /util/traverse-stream`

Similar to `/util/traverse`, but streams the traversal results incrementally.

#### Query Parameters

Identical to `/util/traverse`.

#### Sample Request

```bash
curl -X GET "/util/traverse-stream?source=n::68875f383d1e672f517094ff&detailed=true&depth=2&node_types=Node1&node_types=Node2&edge_types=Edge1" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

#### Sample Streamed Response

```json
{"nodes": [], "edges": [{"id": "e::step1_edge1", "source": "n::start_node", "target": "n::next_node_A"}]}
{"nodes": [{"id": "n::next_node_A", "edges": ["e::step1_edge1"]}], "edges": []}
{"nodes": [], "edges": [{"id": "e::step2_edge1", "source": "n::next_node_A", "target": "n::final_node_B"}]}
{"nodes": [{"id": "n::final_node_B", "edges": ["e::step2_edge1"]}], "edges": []}
```